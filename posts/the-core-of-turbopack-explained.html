<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/a34f9d1faa5f3315-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="preload" as="image" href="/assets/the-core-of-turbopack-explained/image.png"/><link rel="preload" as="image" href="/assets/the-core-of-turbopack-explained/image-1.png"/><link rel="preload" as="image" href="/assets/the-core-of-turbopack-explained/image-2.png"/><link rel="preload" as="image" href="/assets/the-core-of-turbopack-explained/image-3.png"/><link rel="stylesheet" href="/_next/static/css/2eb10676cf259d3f.css" crossorigin="" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-43c42d52cdb06b2d.js" crossorigin=""/><script src="/_next/static/chunks/9a28f2a4-325006bed6c0406c.js" async="" crossorigin=""></script><script src="/_next/static/chunks/748-a46810dc8bd60d1b.js" async="" crossorigin=""></script><script src="/_next/static/chunks/main-app-3645b298c4863d62.js" async="" crossorigin=""></script><script src="/_next/static/chunks/39-cefea7e4f434356b.js" async=""></script><script src="/_next/static/chunks/app/layout-2a9799121329ca53.js" async=""></script><script src="/_next/static/chunks/app/page-401250cce1be0565.js" async=""></script><title>The core of Turbopack explained</title><meta name="description" content="The core of Turbopack explained"/><meta name="next-size-adjust"/><title>hai-x</title><script src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js" crossorigin="" noModule=""></script></head><body><script>((e,t,r,a,o,l,u,i)=>{let s=document.documentElement,c=["light","dark"];function p(t){(Array.isArray(e)?e:[e]).forEach(e=>{let r="class"===e,a=r&&l?o.map(e=>l[e]||e):o;r?(s.classList.remove(...a),s.classList.add(t)):s.setAttribute(e,t)}),i&&c.includes(t)&&(s.style.colorScheme=t)}if(a)p(a);else try{let e=localStorage.getItem(t)||r,a=u&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;p(a)}catch(e){}})("class","theme","system",null,["light","dark"],null,true,true)</script><div class="antialiased min-h-screen bg-white text-slate-900 __className_d65c78"><div class="max-w-2xl mx-auto py-10 px-4"><header><div class="flex items-center justify-between"><div class="w-6 h-6"></div><nav class="ml-auto text-sm font-medium space-x-6"><a href="/">Home</a><a href="/about">About</a></nav></div></header><main><article class="py-6 prose dark:prose-invert"><h1 class="mb-4 break-all">The core of Turbopack explained</h1><p class="text-slate-700">The core of Turbopack explained</p><hr class="my-6"/><h2>ç®€è¿°</h2>
<blockquote>
<p>æ¥æºï¼š webpack ä½œè€… Tobias Koppers åœ¨ JS Nation
JSNation 2023 ä¸Šçš„ coding live ä½œå“
<a href="https://portal.gitnation.org/contents/the-core-of-turbopack-explained-live-coding">The Core of Turbopack Explained (Live Coding)</a></p>
</blockquote>
<blockquote>
<p>ç›®çš„ï¼šè§£å†³ webpack å› å¤§é‡æŸ¥æ‰¾ç¼“å­˜ã€éªŒè¯å¤±æ•ˆç¼“å­˜å¯¼è‡´çš„å¼€é”€è¿‡å¤§é—®é¢˜</p>
</blockquote>
<p>æœ¬æ–‡ç« é€šè¿‡æ¨¡æ‹Ÿä¸€ä¸ªæœ€ç®€æ„å»ºè¿‡ç¨‹æ¥åˆæ¢ Turbo Engine çš„ä¸€äº›åŸç†ã€‚</p>
<h2>å¦‚ä½•å·¥ä½œ</h2>
<p>Turbo Engine ä¼šå°†æŸäº›åŠŸèƒ½æ ‡è®°ä¸º<em>To be remember</em>ã€‚å½“è¿™äº›å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè®°ä½å®ƒä»¬è¢«è°ƒç”¨çš„å†…å®¹ä»¥åŠå®ƒä»¬è¿”å›çš„å†…å®¹ã€‚ç„¶åå®ƒå°†å…¶ä¿å­˜åœ¨ç¼“å­˜ä¸­ã€‚</p>
<p>ä¸€ä¸ªç®€å•çš„ bundle è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºè¯»å–æºç ï¼Œå¯¹æºç è¿›è¡Œæ„å»ºï¼Œæ‹¼æ¥æ„å»ºäº§ç‰©å½¢æˆæœ€ç»ˆäº§ç‰© å¦‚ä¸‹æ‰€ç¤º</p>
<img src="/assets/the-core-of-turbopack-explained/image.png" alt="å›¾å‡ºè‡ª Turbopack å®˜ç½‘"/>
<p>ä¿®æ”¹ <code>sdk.ts</code> çš„ä»£ç æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡æ„å»ºï¼Œå†æ¬¡æ‹¼æ¥äº§ç‰©ã€‚æ­¤æ—¶ï¼Œå¯¹äº <code>api.ts</code> æ–‡ä»¶å¹¶æœªæ”¹åŠ¨ï¼Œæˆ‘ä»¬å°†ä»ç¼“å­˜ä¸­è¯»å– <code>api.ts</code> çš„å†…å®¹å†æ‹¼æ¥å³å¯ã€‚ä»è€Œå‡å°‘äº†å¯¹äº <code>api.ts</code> çš„è¯»å–ä¸æ„å»ºäº§ç”Ÿçš„å¼€é”€ã€‚</p>
<img src="/assets/the-core-of-turbopack-explained/image-1.png" alt="å›¾å‡ºè‡ª Turbopack å®˜ç½‘"/>
<p>å¯¹äºä¸€ä¸ªå…·æœ‰æˆåƒä¸Šç™¾ä¸ªæ–‡ä»¶çš„å·¨åº”ç”¨ï¼Œæ„å»ºå·¥å…·éœ€è¦å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œè·¯å¾„è§£æã€æ–‡ä»¶è¯»å–ã€æºç æ„å»ºã€‚æ‰€æœ‰å·§ç”¨ç¼“å­˜ï¼ˆè®°ä½æ¯æ¬¡å‡½æ•°çš„è°ƒç”¨ç»“æœï¼‰å°†å¯èŠ‚çœå¤§é‡å¼€é”€ã€‚</p>
<p>è¿™ç§è§£å†³æ–¹æ³•èƒ½è®© <code>Turbopack</code> ä»¥æå¿«çš„é€Ÿåº¦è¿›è¡Œåº”ç”¨ç¨‹åºçš„å¢é‡æ„å»ºï¼Œå½“æ–‡ä»¶æ”¹åŠ¨ï¼Œ<code>devServer</code> å°†å¿«é€Ÿæ¥ç®¡å¹¶è¿›è¡Œæ„å»ºå“åº”ã€‚</p>
<h3>å…³äºç¼“å­˜</h3>
<p>Turbo Engine å°†è¿™äº›å†…å­˜ç¼“å­˜åœ¨è¿è¡Œå†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ç¡¬ç›˜å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€ï¼Œå½“å¯åŠ¨ <code>devServer</code> æ—¶ï¼Œæ„å»ºç¼“å­˜å°†ä¸€ç›´å­˜åœ¨ã€‚ç›´åˆ°å…³é—­/åœæ­¢ <code>devServer</code> æ—¶ï¼Œè¿™äº›å†…å­˜å°†è¢«å›æ”¶ã€‚</p>
<h3>åŸç†è§£é‡Š</h3>
<p>æœ€ç®€æ„å»ºè¿‡ç¨‹</p>
<ol>
<li>è¯»å–å…¥å£æ–‡ä»¶æºç ã€è¯»å–è¢«æ‹¼æ¥çš„æ¨¡å— Header (/*_ @copyright the-core-of-turbopack-explained _/)</li>
<li>æ‹¼æ¥æ„å»ºæ¨¡å—</li>
<li>è¾“å‡ºæ„å»ºäº§ç‰©</li>
<li>è§£æå…¥å£æ–‡ä»¶çš„ä¾èµ–</li>
</ol>
<p>ç¬¬ 1,2,3 æ­¥æˆ‘ä»¬ç»Ÿç§°ä¸º <code>copy</code> æ„å»ºé˜¶æ®µï¼Œè€Œåæ‰§è¡Œç¬¬ 4 æ­¥ <code>getImporter</code> æ„å»ºé˜¶æ®µï¼Œå¦‚å‘ç°å­˜åœ¨ä¾èµ–æ–‡ä»¶ï¼Œåˆ™é€’å½’æ‰§è¡Œæ­¤æ„å»ºè¿‡ç¨‹</p>
<pre><code class="language-js">const main = task(&#x27;main&#x27;, () =&gt; {
  const baseDir = path.join(process.cwd(), &#x27;demo&#x27;)
  const outDir = path.join(process.cwd(), &#x27;demo&#x27;, &#x27;dist&#x27;)
  const entry = path.join(baseDir, &#x27;/index.js&#x27;)
  const header = path.join(process.cwd(), &#x27;demo&#x27;, &#x27;header.js&#x27;)
  copyGraph(baseDir, outDir, entry, header)
  log.enable &amp;&amp; printCentered(`ğŸ”¥ğŸ”¥ é¦–æ¬¡æ„å»ºå®Œæˆ ğŸ”¥ğŸ”¥`)
})

// æ„å»ºä¸»æµç¨‹
const copyGraph = task(&#x27;copyGraph&#x27;, (baseDir, outDir, entry, header) =&gt; {
  const relPath = path.relative(baseDir, entry)
  const output = path.join(outDir, relPath)
  copy(output, header, entry)
  const importers = getImporter(entry)
  if (importers?.length &gt; 0)
    for (const importer of importers) {
      copyGraph(baseDir, outDir, importer, header)
    }
})

// è§£æä¾èµ–æ–‡ä»¶çš„è·¯å¾„
const getImporter = task(&#x27;getImporter&#x27;, (entry) =&gt; {
  const ast = parse(read(entry), {
    sourceType: &#x27;module&#x27;,
    ecmaVersion: &#x27;latest&#x27;
  })
  return (
    ast.body
      .filter((node) =&gt; node.type === &#x27;ImportDeclaration&#x27;)
      .map((node) =&gt; node.source.value)
      .filter((value) =&gt; {
        return value.startsWith(&#x27;./&#x27;)
      })
      .map((value) =&gt; path.join(path.dirname(entry), value)) ?? []
  )
})

// è¾“å‡ºæ„å»ºäº§ç‰©
const copy = task(&#x27;copy&#x27;, (output, header, entry) =&gt; {
  write(output, read(header) + read(entry))
})
</code></pre>
<p>æ¯ä¸ªæ„å»ºé˜¶æ®µéƒ½ä½¿ç”¨äº† task å‡½æ•°è¿›è¡ŒåŒ…è£¹ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯å¯¹ã€Œç›¸åŒå…¥å‚ä¸å‡½æ•°åã€å‡½æ•°çš„æ‰§è¡Œç»“æœè¿›è¡Œç¼“å­˜ã€‚</p>
<pre><code class="language-js">const taskCache = new TupleMap()
export let currentTask = null

export const task = (name, f) =&gt; {
  return (...args) =&gt; {
    let task = taskCache.get([name, ...args]) ?? null
    if (!task) {
      task = {
        name,
        args,
        f,
        result: undefined,
        dependentTasks: new Set()
      }
      task.result = wrapCurrentTask(task, () =&gt; logged(name, f, args))
      taskCache.set([name, ...args], task)
    }
    currentTask &amp;&amp; task.dependentTasks.add(currentTask)
    return task.result
  }
}
</code></pre>
<h4>å…³é”®å‡½æ•°ä¸å˜é‡</h4>
<p><code>logged</code> å‡½æ•°ä»…åšæ—¥å¿—æ‰“ç‚¹ç”¨ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šè§£é‡Š</p>
<p><code>currentTask</code> å˜é‡ç”¨æ¥è®°å½•å½“å‰æ‰€å¤„å“ªä¸ªæ„å»ºé˜¶æ®µï¼Œä»¥æ–¹ä¾¿è®°å½•å„ä¸ªæ„å»ºé˜¶æ®µä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<p><code>currentTask</code> å˜é‡è®°å½•è¿˜ä¾èµ– <code>withCurrentTask</code> æ–¹æ³•ï¼Œå…·ä½“æ“ä½œä¸ºï¼š å½“å‰æ„å»ºé˜¶æ®µçš„å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè¿˜åŸ <code>currentTask</code> ä¸ºå…¶çˆ¶çº§æ„å»ºé˜¶æ®µï¼Œç„¶åé€šè¿‡ <code>task.dependentTasks.add(currentTask)</code> æ¥è®°å½•å½“å‰æ„å»ºé˜¶æ®µçš„çˆ¶çº§æ„å»ºé˜¶æ®µã€‚</p>
<pre><code class="language-js">// wrap current task to be able to track dependent tasks
const wrapCurrentTask = (task, f) =&gt; {
  const oldTask = currentTask
  currentTask = task
  try {
    return f()
  } finally {
    currentTask = oldTask
  }
}
</code></pre>
<p>ä¾æ®æ­¤ï¼Œå³å¯æ„å»ºå‡ºä¸€ä¸ªå®Œæ•´çš„ taskCacheï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<img src="/assets/the-core-of-turbopack-explained/image-2.png" alt="Task Cache"/>
<h4>ç¼“å­˜èŠ‚ç‚¹å±æ€§è§£é‡Š</h4>
<ul>
<li>name: æ„å»ºé˜¶æ®µåï¼ŒMap çš„ key ä¹‹ä¸€</li>
<li>f: æ„å»ºæ‰§è¡Œå‡½æ•°</li>
<li>args: æ‰§è¡Œå‡½æ•°çš„å…¥å‚ï¼ŒMap çš„ key ä¹‹ä¸€</li>
<li>dependentTasks: ä»£è¡¨è¯¥æ„å»ºé˜¶æ®µå‡½æ•°çš„çˆ¶çº§é›†åˆ</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å·²å®ç°ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå³å®˜ç½‘ä¸­æåŠçš„ <a href="https://turbo.build/pack/docs/core-concepts#function-level-caching">Function-level caching</a></p>
<ol>
<li>å¯¹äºé‡å¤è·¯å¾„çš„æ–‡ä»¶è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè€Œä¸ç”¨å†æ¬¡è¯»å–ç¡¬ç›˜æ–‡ä»¶ã€‚</li>
<li>å¯¹äºé‡å¤è·¯å¾„çš„ä¾èµ–æ–‡ä»¶è§£æï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè€Œä¸ç”¨å†æ¬¡ä½¿ç”¨ parser è¿›è¡Œä¾èµ–è§£æã€‚</li>
<li>...</li>
</ol>
<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æ”¹åŠ¨ï¼Œä»¥åŠæ–‡ä»¶æ”¹åŠ¨åï¼Œè®©ç¼“å­˜å¤±æ•ˆã€‚</p>
<h4>æ€è€ƒ</h4>
<ul>
<li>å¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ”¹åŠ¨ï¼šæˆ‘ä»¬ç®€å•é€šè¿‡ fs æ¨¡å—çš„ watch å‡½æ•°è¿›è¡Œæ–‡ä»¶ç›‘å¬ã€‚</li>
<li>å¦‚ä½•ä½¿ç¼“å­˜å¤±æ•ˆï¼šå½“æ–‡ä»¶æ”¹åŠ¨åï¼Œå†æ¬¡è¿›è¡Œæ–‡ä»¶è¯»å– read å·¥ä½œï¼Œå¹¶ä¸”æ‰§è¡Œå†’æ³¡æ“ä½œï¼Œå³é€’å½’æ‰§è¡Œçˆ¶çº§æ„å»ºé˜¶æ®µçš„å‡½æ•°ï¼ŒgetImporter, write...ï¼ŒåŒæ—¶è¿›è¡Œç¼“å­˜çš„æ›´æ–°ã€‚</li>
</ul>
<h4>å¦‚ä½•å®ç°</h4>
<p>å…ˆåˆ›å»ºä¸€ä¸ªç¼“å­˜å¤±æ•ˆå‡½æ•°ï¼Œç›®çš„æ˜¯é‡æ–°æ‰§è¡Œ read å‡½æ•°é˜¶æ®µï¼Œä½¿ç¼“å­˜å¤±æ•ˆï¼Œæ›´æ–° <code>task.result</code>ï¼Œå¦‚æœ task.result å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é€’å½’æ‰§è¡Œçˆ¶çº§æ„å»ºé˜¶æ®µçš„å‡½æ•°ã€‚</p>
<pre><code class="language-js">export const invalidate = (task) =&gt; {
  const oldTaskResult = task.result
  // recalculate task
  logged(
    task.name,
    () =&gt; {
      task.result = wrapCurrentTask(task, () =&gt; {
        return task.f(...task.args)
      })
    },
    task.args
  )
  // invalidate dependent tasks
  if (JSON.stringify(oldTaskResult) !== JSON.stringify(task.result)) {
    if (task.dependentTasks.size &gt; 0) {
      for (const dependentTask of task.dependentTasks) {
        invalidate(dependentTask)
      }
    }
  } else {
    log.enable &amp;&amp; printCentered(`ğŸ”¥ğŸ”¥ ${task.name} no change ğŸ”¥ğŸ”¥`)
  }
}
</code></pre>
<p>å°† <code>currentTask</code> ä½œä¸ºå…¥å‚ä¼ å…¥ <code>invalidate</code> ç¼“å­˜å¤±æ•ˆå‡½æ•°ä¸­ï¼Œå³å¯æ˜ç¡® è¯¥å…¥å£æ–‡ä»¶ &amp; è¯¥æ„å»ºé˜¶æ®µ çš„çˆ¶çº§æ„å»ºé“¾ï¼Œä»è€Œå®ç°å†’æ³¡/å¢é‡æ„å»ºä¸­çš„ä¸€ç¯ã€‚</p>
<pre><code class="language-js">export const getInvalidator = () =&gt; {
  if (!currentTask) log.enable &amp;&amp; console.log(&#x27;&gt;&gt;&gt;&gt;&gt;no task&#x27;)
  // need to cache by another variable because currentTask is changing
  const task = currentTask
  return () =&gt; invalidate(task)
}
</code></pre>
<p>ä¸‹ä¸€æ­¥ï¼Œè®©ç¼“å­˜å¤±æ•ˆå‡½æ•°ä¸æ–‡ä»¶ç›‘å¬å‡½æ•°è¿›è¡Œå…³è”ï¼Œå½“æ–‡ä»¶æ”¹åŠ¨æ—¶ï¼Œæ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°ã€‚</p>
<p>å€ŸåŠ©ã€ä»¥ filepath ä½œä¸º key çš„ç¼“å­˜ <code>invalidatorCache</code> ã€æ¥è®°å½•æ¯ä¸ªæ–‡ä»¶çš„ <code>read</code> æ„å»ºé˜¶æ®µçš„ç¼“å­˜å¤±æ•ˆå‡½æ•°ã€‚æ–‡ä»¶æ”¹åŠ¨åï¼Œé€šè¿‡ <code>invalidatorCache</code> æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°ï¼Œæ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°æ¥å®ç°ç›®æ ‡ã€‚</p>
<pre><code class="language-js">export const read = task(&#x27;read&#x27;, (entry) =&gt; {
  const invalidator = getInvalidator()
  // æ³¨å†Œå½“å‰æ–‡ä»¶çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°
  invalidatorCache.set(entry, invalidator)
  return readFileSync(entry, &#x27;utf8&#x27;, (err) =&gt; {
    console.error(&#x27;&gt;&gt;&gt;&gt;&gt;&gt;&gt;read error&#x27;, err)
  })
})
</code></pre>
<pre><code class="language-js">watch(process.cwd(), { recursive: true }, (eventType, filename) =&gt; {
  if (!filename) return
  filename = resolve(filename)
  // æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°
  const invalidator = invalidatorCache.get(filename)
  invalidator &amp;&amp;
    setTimeout(() =&gt; {
      invalidatorCache.delete(filename)
      log.enable &amp;&amp; console.time(&#x27;file change&#x27;)
      // æ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°
      invalidator()
      log.enable &amp;&amp; console.timeEnd(&#x27;file change&#x27;)
    }, 100)
})
</code></pre>
<p>é€šè¿‡ä»¥ä¸Šå‡ ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å³å¯åšåˆ° æ–‡ä»¶æ”¹åŠ¨ =&gt; ä½¿ç¼“å­˜å¤±æ•ˆ =&gt; å¢é‡æ„å»ºã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ª demo æ¥è§£é‡Šä¸€ä¸‹å…¨é“¾è·¯</p>
<pre><code class="language-js">// test/index.js
import { foo as foo1 } from &#x27;./1.js&#x27;
import { foo as foo2 } from &#x27;./2.js&#x27;
import { foo as foo3 } from &#x27;./3.js&#x27;
import { foo as foo4 } from &#x27;./4.js&#x27;
import { foo as foo5 } from &#x27;./5.js&#x27;
import { foo as foo6 } from &#x27;./6.js&#x27;
import { foo as foo7 } from &#x27;./7.js&#x27;
import { foo as foo8 } from &#x27;./8.js&#x27;
import { foo as foo9 } from &#x27;./9.js&#x27;
import { foo as foo10 } from &#x27;./10.js&#x27;
import { foo as foo11 } from &#x27;./11.js&#x27;
import { foo as foo12 } from &#x27;./12.js&#x27;
</code></pre>
<blockquote>
<p>ç¬¬ä¸€æ¬¡æ‰§è¡Œæ„å»ºè¿‡ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹</p>
</blockquote>
<img src="/assets/the-core-of-turbopack-explained/image-3.png" alt="æ„å»ºè¿‡ç¨‹"/>
<h4>å½“ <code>./1.js</code> æ–‡ä»¶æ”¹åŠ¨æ—¶ï¼Œæ‰§è¡Œå¦‚ä¸‹</h4>
<ul>
<li>é‡è¯»å– <code>./1.js</code> æ–‡ä»¶ï¼Œå‘ç° <code>task.result</code> ä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œæ›´æ–°ç¼“å­˜ï¼Œè¿›è¡Œå†’æ³¡ï¼Œæ‰§è¡Œçˆ¶çº§æ„å»ºé“¾</li>
<li>æ‰§è¡Œ <code>copy</code> æ„å»ºé˜¶æ®µï¼Œ<code>writeFile</code> è¾“å‡ºæ„å»ºç»“æœï¼Œ<code>task.result</code> ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œ</li>
<li>æ‰§è¡Œ <code>getImporter</code> æ„å»ºé˜¶æ®µï¼Œ<code>task.result</code> ä¸º [] ç©ºæ•°ç»„ï¼ŒJSON.stringify åï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œ</li>
</ul>
<h4>å½“ <code>index.js</code> æ–‡ä»¶æ”¹åŠ¨ï¼Œå¦‚æ–°å¢ä¾èµ– <code>import</code> è¯­å¥</h4>
<pre><code class="language-js">import { foo as foo14 } from &quot;./14.js&quot;`
</code></pre>
<ul>
<li>é‡è¯»å– <code>./index.js</code> æ–‡ä»¶ï¼Œå‘ç° <code>task.result</code> ä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œæ›´æ–°ç¼“å­˜ï¼Œè¿›è¡Œå†’æ³¡ï¼Œæ‰§è¡Œçˆ¶çº§æ„å»ºé“¾</li>
<li>æ‰§è¡Œ <code>copy</code> æ„å»ºé˜¶æ®µï¼Œ<code>writeFile</code> è¾“å‡ºæ„å»ºç»“æœï¼Œ<code>task.result</code> ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œã€‚</li>
<li>æ‰§è¡Œ <code>getImporter</code> æ„å»ºé˜¶æ®µï¼Œ<code>task.result</code> æ•°ç»„æ–°å¢ä¸€é¡¹ï¼Œä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œè¿›è¡Œå†’æ³¡ã€‚</li>
<li>æ‰§è¡Œ <code>./index.js</code> çš„ <code>copyGraph</code> æ„å»ºé˜¶æ®µï¼Œ<code>./1.js</code> è‡³ <code>./13.js</code> çš„æ„å»ºé˜¶æ®µçš†è¢«ç¼“å­˜ï¼Œä¸å†æ‰§è¡Œã€‚</li>
<li>æ‰§è¡Œ <code>./14.js</code> çš„ <code>copyGraph</code> æ„å»ºé˜¶æ®µï¼Œæœªå‘½ä¸­ç¼“å­˜ï¼Œæ‰§è¡Œ <code>copy</code> ä¸ <code>getImporter</code> æ„å»ºé˜¶æ®µï¼Œå¹¶è¿›è¡Œ task ç¼“å­˜ã€‚</li>
<li><code>./index.js</code> çš„ <code>copyGraph</code> æ„å»ºé˜¶æ®µçš„<code>task.result</code> ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œã€‚</li>
</ul>
<h2>ç»“è¯­</h2>
<p>æ¬¢è¿ ğŸ”— Fork æˆ– â¤ï¸ Star æœ¬ä»“åº“ <a href="https://github.com/haijie-x/the-core-of-turbopack-explained">the-core-of-turbopack-explained</a> å…±åŒæ¢è®¨ä¸å­¦ä¹ ã€‚</p>
<h2>å‚è€ƒ</h2>
<ul>
<li>https://portal.gitnation.org/contents/the-core-of-turbopack-explained-live-coding</li>
<li>https://turbo.build/pack/docs/core-concepts</li>
</ul></article></main><footer class="mt-8"><hr class="my-4"/><small class="flex justify-end "><nav class="underline decoration-1"><a class="mr-3" href="https://github.com/hai-x">@github</a><a href="https://twitter.com/__haijie">@twitter</a></nav></small></footer></div></div><script src="/_next/static/chunks/webpack-43c42d52cdb06b2d.js" crossorigin="" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/a34f9d1faa5f3315-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/2eb10676cf259d3f.css\",\"style\",{\"crossOrigin\":\"\"}]\n0:\"$L3\"\n"])</script><script>self.__next_f.push([1,"4:I[2478,[],\"\"]\n6:I[2280,[],\"\"]\n7:I[4336,[\"39\",\"static/chunks/39-cefea7e4f434356b.js\",\"185\",\"static/chunks/app/layout-2a9799121329ca53.js\"],\"ThemeProvider\"]\n8:I[3386,[\"39\",\"static/chunks/39-cefea7e4f434356b.js\",\"185\",\"static/chunks/app/layout-2a9799121329ca53.js\"],\"\"]\n9:I[6039,[\"39\",\"static/chunks/39-cefea7e4f434356b.js\",\"931\",\"static/chunks/app/page-401250cce1be0565.js\"],\"\"]\na:I[1974,[],\"\"]\nb:I[6496,[],\"\"]\n"])</script><script>self.__next_f.push([1,"3:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2eb10676cf259d3f.css\",\"precedence\":\"next\",\"crossOrigin\":\"\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"PWEdH4xjP9aCV2hKPEY47\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/posts/the-core-of-turbopack-explained\",\"initialTree\":[\"\",{\"children\":[\"posts\",{\"children\":[[\"slug\",\"the-core-of-turbopack-explained\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"the-core-of-turbopack-explained\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L5\"],\"globalErrorComponent\":\"$6\",\"children\":[null,[\"$\",\"html\",null,{\"lang\":\"en\",\"suppressHydrationWarning\":true,\"children\":[[\"$\",\"title\",null,{\"children\":\"hai-x\"}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L7\",null,{\"attribute\":\"class\",\"children\":[\"$\",\"div\",null,{\"className\":\"antialiased min-h-screen bg-white text-slate-900 __className_d65c78\",\"children\":[\"$\",\"div\",null,{\"className\":\"max-w-2xl mx-auto py-10 px-4\",\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between\",\"children\":[[\"$\",\"$L8\",null,{}],[\"$\",\"nav\",null,{\"className\":\"ml-auto text-sm font-medium space-x-6\",\"children\":[[\"$\",\"$L9\",null,{\"href\":\"/\",\"children\":\"Home\"}],[\"$\",\"$L9\",null,{\"href\":\"/about\",\"children\":\"About\"}]]}]]}]}],[\"$\",\"main\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",[\"slug\",\"the-core-of-turbopack-explained\",\"c\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Lc\",\"$Ld\",null],\"segment\":\"__PAGE__?{\\\"slug\\\":[\\\"the-core-of-turbopack-explained\\\"]}\"},\"styles\":[]}],\"segment\":[\"slug\",\"the-core-of-turbopack-explained\",\"c\"]},\"styles\":[]}],\"segment\":\"posts\"},\"styles\":[]}]}],[\"$\",\"footer\",null,{\"className\":\"mt-8\",\"children\":[[\"$\",\"hr\",null,{\"className\":\"my-4\"}],[\"$\",\"small\",null,{\"className\":\"flex justify-end \",\"children\":[\"$\",\"nav\",null,{\"className\":\"underline decoration-1\",\"children\":[[\"$\",\"$L9\",null,{\"href\":\"https://github.com/hai-x\",\"className\":\"mr-3\",\"children\":\"@github\"}],[\"$\",\"$L9\",null,{\"href\":\"https://twitter.com/__haijie\",\"children\":\"@twitter\"}]]}]}]]}]]}]}]}]}]]}],null]}]]\n"])</script><script>self.__next_f.push([1,"e:T530,"])</script><script>self.__next_f.push([1,"const main = task('main', () =\u003e {\n  const baseDir = path.join(process.cwd(), 'demo')\n  const outDir = path.join(process.cwd(), 'demo', 'dist')\n  const entry = path.join(baseDir, '/index.js')\n  const header = path.join(process.cwd(), 'demo', 'header.js')\n  copyGraph(baseDir, outDir, entry, header)\n  log.enable \u0026\u0026 printCentered(`ğŸ”¥ğŸ”¥ é¦–æ¬¡æ„å»ºå®Œæˆ ğŸ”¥ğŸ”¥`)\n})\n\n// æ„å»ºä¸»æµç¨‹\nconst copyGraph = task('copyGraph', (baseDir, outDir, entry, header) =\u003e {\n  const relPath = path.relative(baseDir, entry)\n  const output = path.join(outDir, relPath)\n  copy(output, header, entry)\n  const importers = getImporter(entry)\n  if (importers?.length \u003e 0)\n    for (const importer of importers) {\n      copyGraph(baseDir, outDir, importer, header)\n    }\n})\n\n// è§£æä¾èµ–æ–‡ä»¶çš„è·¯å¾„\nconst getImporter = task('getImporter', (entry) =\u003e {\n  const ast = parse(read(entry), {\n    sourceType: 'module',\n    ecmaVersion: 'latest'\n  })\n  return (\n    ast.body\n      .filter((node) =\u003e node.type === 'ImportDeclaration')\n      .map((node) =\u003e node.source.value)\n      .filter((value) =\u003e {\n        return value.startsWith('./')\n      })\n      .map((value) =\u003e path.join(path.dirname(entry), value)) ?? []\n  )\n})\n\n// è¾“å‡ºæ„å»ºäº§ç‰©\nconst copy = task('copy', (output, header, entry) =\u003e {\n  write(output, read(header) + read(entry))\n})\n"])</script><script>self.__next_f.push([1,"d:[\"$\",\"article\",null,{\"className\":\"py-6 prose dark:prose-invert\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"mb-4 break-all\",\"children\":\"The core of Turbopack explained\"}],[\"$\",\"p\",null,{\"className\":\"text-slate-700\",\"children\":\"The core of Turbopack explained\"}],[\"$\",\"hr\",null,{\"className\":\"my-6\"}],[[\"$\",\"h2\",null,{\"children\":\"ç®€è¿°\"}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":[\"æ¥æºï¼š webpack ä½œè€… Tobias Koppers åœ¨ JS Nation\\nJSNation 2023 ä¸Šçš„ coding live ä½œå“\\n\",[\"$\",\"a\",null,{\"href\":\"https://portal.gitnation.org/contents/the-core-of-turbopack-explained-live-coding\",\"children\":\"The Core of Turbopack Explained (Live Coding)\"}]]}],\"\\n\"]}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"ç›®çš„ï¼šè§£å†³ webpack å› å¤§é‡æŸ¥æ‰¾ç¼“å­˜ã€éªŒè¯å¤±æ•ˆç¼“å­˜å¯¼è‡´çš„å¼€é”€è¿‡å¤§é—®é¢˜\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"æœ¬æ–‡ç« é€šè¿‡æ¨¡æ‹Ÿä¸€ä¸ªæœ€ç®€æ„å»ºè¿‡ç¨‹æ¥åˆæ¢ Turbo Engine çš„ä¸€äº›åŸç†ã€‚\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"å¦‚ä½•å·¥ä½œ\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Turbo Engine ä¼šå°†æŸäº›åŠŸèƒ½æ ‡è®°ä¸º\",[\"$\",\"em\",null,{\"children\":\"To be remember\"}],\"ã€‚å½“è¿™äº›å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šè®°ä½å®ƒä»¬è¢«è°ƒç”¨çš„å†…å®¹ä»¥åŠå®ƒä»¬è¿”å›çš„å†…å®¹ã€‚ç„¶åå®ƒå°†å…¶ä¿å­˜åœ¨ç¼“å­˜ä¸­ã€‚\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ä¸€ä¸ªç®€å•çš„ bundle è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºè¯»å–æºç ï¼Œå¯¹æºç è¿›è¡Œæ„å»ºï¼Œæ‹¼æ¥æ„å»ºäº§ç‰©å½¢æˆæœ€ç»ˆäº§ç‰© å¦‚ä¸‹æ‰€ç¤º\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/assets/the-core-of-turbopack-explained/image.png\",\"alt\":\"å›¾å‡ºè‡ª Turbopack å®˜ç½‘\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"ä¿®æ”¹ \",[\"$\",\"code\",null,{\"children\":\"sdk.ts\"}],\" çš„ä»£ç æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å†æ¬¡æ„å»ºï¼Œå†æ¬¡æ‹¼æ¥äº§ç‰©ã€‚æ­¤æ—¶ï¼Œå¯¹äº \",[\"$\",\"code\",null,{\"children\":\"api.ts\"}],\" æ–‡ä»¶å¹¶æœªæ”¹åŠ¨ï¼Œæˆ‘ä»¬å°†ä»ç¼“å­˜ä¸­è¯»å– \",[\"$\",\"code\",null,{\"children\":\"api.ts\"}],\" çš„å†…å®¹å†æ‹¼æ¥å³å¯ã€‚ä»è€Œå‡å°‘äº†å¯¹äº \",[\"$\",\"code\",null,{\"children\":\"api.ts\"}],\" çš„è¯»å–ä¸æ„å»ºäº§ç”Ÿçš„å¼€é”€ã€‚\"]}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/assets/the-core-of-turbopack-explained/image-1.png\",\"alt\":\"å›¾å‡ºè‡ª Turbopack å®˜ç½‘\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"å¯¹äºä¸€ä¸ªå…·æœ‰æˆåƒä¸Šç™¾ä¸ªæ–‡ä»¶çš„å·¨åº”ç”¨ï¼Œæ„å»ºå·¥å…·éœ€è¦å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œè·¯å¾„è§£æã€æ–‡ä»¶è¯»å–ã€æºç æ„å»ºã€‚æ‰€æœ‰å·§ç”¨ç¼“å­˜ï¼ˆè®°ä½æ¯æ¬¡å‡½æ•°çš„è°ƒç”¨ç»“æœï¼‰å°†å¯èŠ‚çœå¤§é‡å¼€é”€ã€‚\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"è¿™ç§è§£å†³æ–¹æ³•èƒ½è®© \",[\"$\",\"code\",null,{\"children\":\"Turbopack\"}],\" ä»¥æå¿«çš„é€Ÿåº¦è¿›è¡Œåº”ç”¨ç¨‹åºçš„å¢é‡æ„å»ºï¼Œå½“æ–‡ä»¶æ”¹åŠ¨ï¼Œ\",[\"$\",\"code\",null,{\"children\":\"devServer\"}],\" å°†å¿«é€Ÿæ¥ç®¡å¹¶è¿›è¡Œæ„å»ºå“åº”ã€‚\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"å…³äºç¼“å­˜\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Turbo Engine å°†è¿™äº›å†…å­˜ç¼“å­˜åœ¨è¿è¡Œå†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ç¡¬ç›˜å†…å­˜ä¸­ï¼Œè¿™æ„å‘³ç€ï¼Œå½“å¯åŠ¨ \",[\"$\",\"code\",null,{\"children\":\"devServer\"}],\" æ—¶ï¼Œæ„å»ºç¼“å­˜å°†ä¸€ç›´å­˜åœ¨ã€‚ç›´åˆ°å…³é—­/åœæ­¢ \",[\"$\",\"code\",null,{\"children\":\"devServer\"}],\" æ—¶ï¼Œè¿™äº›å†…å­˜å°†è¢«å›æ”¶ã€‚\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"åŸç†è§£é‡Š\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"æœ€ç®€æ„å»ºè¿‡ç¨‹\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"è¯»å–å…¥å£æ–‡ä»¶æºç ã€è¯»å–è¢«æ‹¼æ¥çš„æ¨¡å— Header (/*_ @copyright the-core-of-turbopack-explained _/)\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"æ‹¼æ¥æ„å»ºæ¨¡å—\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"è¾“å‡ºæ„å»ºäº§ç‰©\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"è§£æå…¥å£æ–‡ä»¶çš„ä¾èµ–\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"ç¬¬ 1,2,3 æ­¥æˆ‘ä»¬ç»Ÿç§°ä¸º \",[\"$\",\"code\",null,{\"children\":\"copy\"}],\" æ„å»ºé˜¶æ®µï¼Œè€Œåæ‰§è¡Œç¬¬ 4 æ­¥ \",[\"$\",\"code\",null,{\"children\":\"getImporter\"}],\" æ„å»ºé˜¶æ®µï¼Œå¦‚å‘ç°å­˜åœ¨ä¾èµ–æ–‡ä»¶ï¼Œåˆ™é€’å½’æ‰§è¡Œæ­¤æ„å»ºè¿‡ç¨‹\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"$e\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"æ¯ä¸ªæ„å»ºé˜¶æ®µéƒ½ä½¿ç”¨äº† task å‡½æ•°è¿›è¡ŒåŒ…è£¹ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ç›®çš„æ˜¯å¯¹ã€Œç›¸åŒå…¥å‚ä¸å‡½æ•°åã€å‡½æ•°çš„æ‰§è¡Œç»“æœè¿›è¡Œç¼“å­˜ã€‚\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"const taskCache = new TupleMap()\\nexport let currentTask = null\\n\\nexport const task = (name, f) =\u003e {\\n  return (...args) =\u003e {\\n    let task = taskCache.get([name, ...args]) ?? null\\n    if (!task) {\\n      task = {\\n        name,\\n        args,\\n        f,\\n        result: undefined,\\n        dependentTasks: new Set()\\n      }\\n      task.result = wrapCurrentTask(task, () =\u003e logged(name, f, args))\\n      taskCache.set([name, ...args], task)\\n    }\\n    currentTask \u0026\u0026 task.dependentTasks.add(currentTask)\\n    return task.result\\n  }\\n}\\n\"}]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"å…³é”®å‡½æ•°ä¸å˜é‡\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"logged\"}],\" å‡½æ•°ä»…åšæ—¥å¿—æ‰“ç‚¹ç”¨ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šè§£é‡Š\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"currentTask\"}],\" å˜é‡ç”¨æ¥è®°å½•å½“å‰æ‰€å¤„å“ªä¸ªæ„å»ºé˜¶æ®µï¼Œä»¥æ–¹ä¾¿è®°å½•å„ä¸ªæ„å»ºé˜¶æ®µä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"currentTask\"}],\" å˜é‡è®°å½•è¿˜ä¾èµ– \",[\"$\",\"code\",null,{\"children\":\"withCurrentTask\"}],\" æ–¹æ³•ï¼Œå…·ä½“æ“ä½œä¸ºï¼š å½“å‰æ„å»ºé˜¶æ®µçš„å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œä¼šè¿˜åŸ \",[\"$\",\"code\",null,{\"children\":\"currentTask\"}],\" ä¸ºå…¶çˆ¶çº§æ„å»ºé˜¶æ®µï¼Œç„¶åé€šè¿‡ \",[\"$\",\"code\",null,{\"children\":\"task.dependentTasks.add(currentTask)\"}],\" æ¥è®°å½•å½“å‰æ„å»ºé˜¶æ®µçš„çˆ¶çº§æ„å»ºé˜¶æ®µã€‚\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"// wrap current task to be able to track dependent tasks\\nconst wrapCurrentTask = (task, f) =\u003e {\\n  const oldTask = currentTask\\n  currentTask = task\\n  try {\\n    return f()\\n  } finally {\\n    currentTask = oldTask\\n  }\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ä¾æ®æ­¤ï¼Œå³å¯æ„å»ºå‡ºä¸€ä¸ªå®Œæ•´çš„ taskCacheï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\"}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/assets/the-core-of-turbopack-explained/image-2.png\",\"alt\":\"Task Cache\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"ç¼“å­˜èŠ‚ç‚¹å±æ€§è§£é‡Š\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"name: æ„å»ºé˜¶æ®µåï¼ŒMap çš„ key ä¹‹ä¸€\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"f: æ„å»ºæ‰§è¡Œå‡½æ•°\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"args: æ‰§è¡Œå‡½æ•°çš„å…¥å‚ï¼ŒMap çš„ key ä¹‹ä¸€\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"dependentTasks: ä»£è¡¨è¯¥æ„å»ºé˜¶æ®µå‡½æ•°çš„çˆ¶çº§é›†åˆ\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"ç°åœ¨æˆ‘ä»¬å·²å®ç°ç¬¬ä¸€ä¸ªåŠŸèƒ½ï¼Œå³å®˜ç½‘ä¸­æåŠçš„ \",[\"$\",\"a\",null,{\"href\":\"https://turbo.build/pack/docs/core-concepts#function-level-caching\",\"children\":\"Function-level caching\"}]]}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"å¯¹äºé‡å¤è·¯å¾„çš„æ–‡ä»¶è¯»å–ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè€Œä¸ç”¨å†æ¬¡è¯»å–ç¡¬ç›˜æ–‡ä»¶ã€‚\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"å¯¹äºé‡å¤è·¯å¾„çš„ä¾èµ–æ–‡ä»¶è§£æï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–ï¼Œè€Œä¸ç”¨å†æ¬¡ä½¿ç”¨ parser è¿›è¡Œä¾èµ–è§£æã€‚\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"...\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ä½†æ˜¯ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ˜¯å¦æ”¹åŠ¨ï¼Œä»¥åŠæ–‡ä»¶æ”¹åŠ¨åï¼Œè®©ç¼“å­˜å¤±æ•ˆã€‚\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"æ€è€ƒ\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"å¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ”¹åŠ¨ï¼šæˆ‘ä»¬ç®€å•é€šè¿‡ fs æ¨¡å—çš„ watch å‡½æ•°è¿›è¡Œæ–‡ä»¶ç›‘å¬ã€‚\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"å¦‚ä½•ä½¿ç¼“å­˜å¤±æ•ˆï¼šå½“æ–‡ä»¶æ”¹åŠ¨åï¼Œå†æ¬¡è¿›è¡Œæ–‡ä»¶è¯»å– read å·¥ä½œï¼Œå¹¶ä¸”æ‰§è¡Œå†’æ³¡æ“ä½œï¼Œå³é€’å½’æ‰§è¡Œçˆ¶çº§æ„å»ºé˜¶æ®µçš„å‡½æ•°ï¼ŒgetImporter, write...ï¼ŒåŒæ—¶è¿›è¡Œç¼“å­˜çš„æ›´æ–°ã€‚\"}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":\"å¦‚ä½•å®ç°\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"å…ˆåˆ›å»ºä¸€ä¸ªç¼“å­˜å¤±æ•ˆå‡½æ•°ï¼Œç›®çš„æ˜¯é‡æ–°æ‰§è¡Œ read å‡½æ•°é˜¶æ®µï¼Œä½¿ç¼“å­˜å¤±æ•ˆï¼Œæ›´æ–° \",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\"ï¼Œå¦‚æœ task.result å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é€’å½’æ‰§è¡Œçˆ¶çº§æ„å»ºé˜¶æ®µçš„å‡½æ•°ã€‚\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"export const invalidate = (task) =\u003e {\\n  const oldTaskResult = task.result\\n  // recalculate task\\n  logged(\\n    task.name,\\n    () =\u003e {\\n      task.result = wrapCurrentTask(task, () =\u003e {\\n        return task.f(...task.args)\\n      })\\n    },\\n    task.args\\n  )\\n  // invalidate dependent tasks\\n  if (JSON.stringify(oldTaskResult) !== JSON.stringify(task.result)) {\\n    if (task.dependentTasks.size \u003e 0) {\\n      for (const dependentTask of task.dependentTasks) {\\n        invalidate(dependentTask)\\n      }\\n    }\\n  } else {\\n    log.enable \u0026\u0026 printCentered(`ğŸ”¥ğŸ”¥ ${task.name} no change ğŸ”¥ğŸ”¥`)\\n  }\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"å°† \",[\"$\",\"code\",null,{\"children\":\"currentTask\"}],\" ä½œä¸ºå…¥å‚ä¼ å…¥ \",[\"$\",\"code\",null,{\"children\":\"invalidate\"}],\" ç¼“å­˜å¤±æ•ˆå‡½æ•°ä¸­ï¼Œå³å¯æ˜ç¡® è¯¥å…¥å£æ–‡ä»¶ \u0026 è¯¥æ„å»ºé˜¶æ®µ çš„çˆ¶çº§æ„å»ºé“¾ï¼Œä»è€Œå®ç°å†’æ³¡/å¢é‡æ„å»ºä¸­çš„ä¸€ç¯ã€‚\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"export const getInvalidator = () =\u003e {\\n  if (!currentTask) log.enable \u0026\u0026 console.log('\u003e\u003e\u003e\u003e\u003eno task')\\n  // need to cache by another variable because currentTask is changing\\n  const task = currentTask\\n  return () =\u003e invalidate(task)\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ä¸‹ä¸€æ­¥ï¼Œè®©ç¼“å­˜å¤±æ•ˆå‡½æ•°ä¸æ–‡ä»¶ç›‘å¬å‡½æ•°è¿›è¡Œå…³è”ï¼Œå½“æ–‡ä»¶æ”¹åŠ¨æ—¶ï¼Œæ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°ã€‚\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"å€ŸåŠ©ã€ä»¥ filepath ä½œä¸º key çš„ç¼“å­˜ \",[\"$\",\"code\",null,{\"children\":\"invalidatorCache\"}],\" ã€æ¥è®°å½•æ¯ä¸ªæ–‡ä»¶çš„ \",[\"$\",\"code\",null,{\"children\":\"read\"}],\" æ„å»ºé˜¶æ®µçš„ç¼“å­˜å¤±æ•ˆå‡½æ•°ã€‚æ–‡ä»¶æ”¹åŠ¨åï¼Œé€šè¿‡ \",[\"$\",\"code\",null,{\"children\":\"invalidatorCache\"}],\" æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°ï¼Œæ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°æ¥å®ç°ç›®æ ‡ã€‚\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"export const read = task('read', (entry) =\u003e {\\n  const invalidator = getInvalidator()\\n  // æ³¨å†Œå½“å‰æ–‡ä»¶çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°\\n  invalidatorCache.set(entry, invalidator)\\n  return readFileSync(entry, 'utf8', (err) =\u003e {\\n    console.error('\u003e\u003e\u003e\u003e\u003e\u003e\u003eread error', err)\\n  })\\n})\\n\"}]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"watch(process.cwd(), { recursive: true }, (eventType, filename) =\u003e {\\n  if (!filename) return\\n  filename = resolve(filename)\\n  // æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜å¤±æ•ˆå‡½æ•°\\n  const invalidator = invalidatorCache.get(filename)\\n  invalidator \u0026\u0026\\n    setTimeout(() =\u003e {\\n      invalidatorCache.delete(filename)\\n      log.enable \u0026\u0026 console.time('file change')\\n      // æ‰§è¡Œç¼“å­˜å¤±æ•ˆå‡½æ•°\\n      invalidator()\\n      log.enable \u0026\u0026 console.timeEnd('file change')\\n    }, 100)\\n})\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"é€šè¿‡ä»¥ä¸Šå‡ ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å³å¯åšåˆ° æ–‡ä»¶æ”¹åŠ¨ =\u003e ä½¿ç¼“å­˜å¤±æ•ˆ =\u003e å¢é‡æ„å»ºã€‚\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ª demo æ¥è§£é‡Šä¸€ä¸‹å…¨é“¾è·¯\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"// test/index.js\\nimport { foo as foo1 } from './1.js'\\nimport { foo as foo2 } from './2.js'\\nimport { foo as foo3 } from './3.js'\\nimport { foo as foo4 } from './4.js'\\nimport { foo as foo5 } from './5.js'\\nimport { foo as foo6 } from './6.js'\\nimport { foo as foo7 } from './7.js'\\nimport { foo as foo8 } from './8.js'\\nimport { foo as foo9 } from './9.js'\\nimport { foo as foo10 } from './10.js'\\nimport { foo as foo11 } from './11.js'\\nimport { foo as foo12 } from './12.js'\\n\"}]}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"ç¬¬ä¸€æ¬¡æ‰§è¡Œæ„å»ºè¿‡ç¨‹ï¼Œæµç¨‹å¦‚ä¸‹\"}],\"\\n\"]}],\"\\n\",[\"$\",\"img\",null,{\"src\":\"/assets/the-core-of-turbopack-explained/image-3.png\",\"alt\":\"æ„å»ºè¿‡ç¨‹\"}],\"\\n\",[\"$\",\"h4\",null,{\"children\":[\"å½“ \",[\"$\",\"code\",null,{\"children\":\"./1.js\"}],\" æ–‡ä»¶æ”¹åŠ¨æ—¶ï¼Œæ‰§è¡Œå¦‚ä¸‹\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"é‡è¯»å– \",[\"$\",\"code\",null,{\"children\":\"./1.js\"}],\" æ–‡ä»¶ï¼Œå‘ç° \",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œæ›´æ–°ç¼“å­˜ï¼Œè¿›è¡Œå†’æ³¡ï¼Œæ‰§è¡Œçˆ¶çº§æ„å»ºé“¾\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"copy\"}],\" æ„å»ºé˜¶æ®µï¼Œ\",[\"$\",\"code\",null,{\"children\":\"writeFile\"}],\" è¾“å‡ºæ„å»ºç»“æœï¼Œ\",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œ\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"getImporter\"}],\" æ„å»ºé˜¶æ®µï¼Œ\",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸º [] ç©ºæ•°ç»„ï¼ŒJSON.stringify åï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œ\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h4\",null,{\"children\":[\"å½“ \",[\"$\",\"code\",null,{\"children\":\"index.js\"}],\" æ–‡ä»¶æ”¹åŠ¨ï¼Œå¦‚æ–°å¢ä¾èµ– \",[\"$\",\"code\",null,{\"children\":\"import\"}],\" è¯­å¥\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-js\",\"children\":\"import { foo as foo14 } from \\\"./14.js\\\"`\\n\"}]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"é‡è¯»å– \",[\"$\",\"code\",null,{\"children\":\"./index.js\"}],\" æ–‡ä»¶ï¼Œå‘ç° \",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œæ›´æ–°ç¼“å­˜ï¼Œè¿›è¡Œå†’æ³¡ï¼Œæ‰§è¡Œçˆ¶çº§æ„å»ºé“¾\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"copy\"}],\" æ„å»ºé˜¶æ®µï¼Œ\",[\"$\",\"code\",null,{\"children\":\"writeFile\"}],\" è¾“å‡ºæ„å»ºç»“æœï¼Œ\",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œã€‚\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"getImporter\"}],\" æ„å»ºé˜¶æ®µï¼Œ\",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" æ•°ç»„æ–°å¢ä¸€é¡¹ï¼Œä¸ä¹‹å‰ç»“æœä¸ä¸€è‡´ï¼Œè¿›è¡Œå†’æ³¡ã€‚\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"./index.js\"}],\" çš„ \",[\"$\",\"code\",null,{\"children\":\"copyGraph\"}],\" æ„å»ºé˜¶æ®µï¼Œ\",[\"$\",\"code\",null,{\"children\":\"./1.js\"}],\" è‡³ \",[\"$\",\"code\",null,{\"children\":\"./13.js\"}],\" çš„æ„å»ºé˜¶æ®µçš†è¢«ç¼“å­˜ï¼Œä¸å†æ‰§è¡Œã€‚\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"æ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"./14.js\"}],\" çš„ \",[\"$\",\"code\",null,{\"children\":\"copyGraph\"}],\" æ„å»ºé˜¶æ®µï¼Œæœªå‘½ä¸­ç¼“å­˜ï¼Œæ‰§è¡Œ \",[\"$\",\"code\",null,{\"children\":\"copy\"}],\" ä¸ \",[\"$\",\"code\",null,{\"children\":\"getImporter\"}],\" æ„å»ºé˜¶æ®µï¼Œå¹¶è¿›è¡Œ task ç¼“å­˜ã€‚\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"./index.js\"}],\" çš„ \",[\"$\",\"code\",null,{\"children\":\"copyGraph\"}],\" æ„å»ºé˜¶æ®µçš„\",[\"$\",\"code\",null,{\"children\":\"task.result\"}],\" ä¸º undefinedï¼Œä¸ä¹‹å‰ç»“æœä¸€è‡´ï¼Œç»“æŸæ‰§è¡Œã€‚\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"ç»“è¯­\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"æ¬¢è¿ ğŸ”— Fork æˆ– â¤ï¸ Star æœ¬ä»“åº“ \",[\"$\",\"a\",null,{\"href\":\"https://github.com/haijie-x/the-core-of-turbopack-explained\",\"children\":\"the-core-of-turbopack-explained\"}],\" å…±åŒæ¢è®¨ä¸å­¦ä¹ ã€‚\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"å‚è€ƒ\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"https://portal.gitnation.org/contents/the-core-of-turbopack-explained-live-coding\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"https://turbo.build/pack/docs/core-concepts\"}],\"\\n\"]}]]]}]\n"])</script><script>self.__next_f.push([1,"5:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"The core of Turbopack explained\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"The core of Turbopack explained\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"4\",{\"name\":\"next-size-adjust\"}]]\nc:null\n"])</script></body></html>